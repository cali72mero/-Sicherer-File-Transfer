<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer V8 - Ultimate (No P2P)</title>
    <!-- We switch from PeerJS (WebRTC) to PieSocket (WebSocket) to bypass strict Firewalls -->
    <script src="https://unpkg.com/piesocket-js@5"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #222; color: white; max-width: 600px; margin: 0 auto; text-align: center; }
        .box { background: #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        input { font-size: 18px; padding: 10px; width: 80%; margin: 10px 0; border-radius: 5px; text-align: center; }
        button { font-size: 18px; padding: 12px 24px; background: #e91e63; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px; }
        .hidden { display: none; }
        .log { font-family: monospace; color: #aaa; font-size: 12px; text-align: left; background: #111; padding: 10px; height: 150px; overflow-y: scroll; }
        a { color: #4caf50; font-weight: bold; text-decoration: none; font-size: 18px; }
    </style>
</head>
<body>

    <h1>üöÄ Transfer V8 (Firewall-Bypass)</h1>
    <p style="font-size: 0.9em; color: #aaa;">Nutzt WebSockets statt WebRTC (l√§uft fast √ºberall).</p>

    <!-- 1. Raum -->
    <div id="step1" class="box">
        <h3>1. Gemeinsamer Raum</h3>
        <p>Denkt euch eine geheime Zahl aus (z.B. 1234):</p>
        <input type="number" id="roomCode" placeholder="Code (z.B. 5566)">
        <button onclick="joinRoom()">Raum beitreten</button>
    </div>

    <!-- 2. Transfer -->
    <div id="step2" class="box hidden">
        <h3>‚úÖ Im Raum: <span id="roomDisplay"></span></h3>
        <p id="status">Warte auf Partner...</p>
        
        <div style="border: 2px dashed #e91e63; padding: 20px; margin: 20px 0;">
            <input type="file" id="fileInput">
            <button onclick="uploadFile()">Senden</button>
        </div>

        <h3>Empfangene Dateien:</h3>
        <div id="fileList"></div>
    </div>

    <div id="debug" class="log">System bereit.</div>

    <script>
        // FREE API KEY for PieSocket (Public Demo Key)
        // Warning: Limited daily usage, but works for testing.
        const API_KEY = 'VCXCEuvhGcBDP7XhiJJUDvR1e1D3eiVjgZ9VRiaV'; 
        const CLUSTER_ID = 'free.blr2.piesocket.com';

        let channel;
        let myName = 'User' + Math.floor(Math.random() * 1000);

        function log(msg) {
            const d = document.getElementById('debug');
            d.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + d.innerHTML;
        }

        function joinRoom() {
            const code = document.getElementById('roomCode').value;
            if (!code) return alert("Code eingeben!");

            log("Verbinde zu Raum " + code + " via WebSocket...");
            
            // PieSocket connection
            var piesocket = new PieSocket.default({
                clusterId: CLUSTER_ID,
                apiKey: API_KEY
            });

            channel = piesocket.subscribe(code);

            channel.on('open', () => {
                log("‚úÖ Verbunden mit Server!");
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                document.getElementById('roomDisplay').innerText = code;
                
                // Announce self
                channel.publish("system", JSON.stringify({ type: 'JOIN', name: myName }));
            });

            channel.on('message', (msg) => {
                // Check if message is system or data
                // PieSocket sends raw events
            });

            channel.listen("system", (data, meta) => {
                const d = JSON.parse(data);
                if (d.type === 'JOIN' && d.name !== myName) {
                    log("Partner " + d.name + " ist beigetreten!");
                    document.getElementById('status').innerText = "Partner ist da!";
                }
            });

            channel.listen("file_transfer", (data, meta) => {
                log("Datei-Daten empfangen...");
                const d = JSON.parse(data);
                
                // Reassemble Base64
                fetch(d.data)
                .then(res => res.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <div style="padding:10px; border-bottom:1px solid #555;">
                            ${d.name} (${(d.size/1024).toFixed(1)} KB)<br>
                            <a href="${url}" download="${d.name}">‚¨áÔ∏è Download</a>
                        </div>
                    `;
                    document.getElementById('fileList').prepend(div);
                    log("Datei fertig: " + d.name);
                });
            });
            
            channel.on('error', (err) => {
                log("Fehler: " + err);
            });
        }

        function uploadFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            if (file.size > 1000000) { // 1MB limit for WebSocket
                return alert("Achtung: In dieser Fallback-Version gehen nur kleine Dateien (max 1MB). Dein Netzwerk blockiert gro√üe P2P-Transfers.");
            }

            log("Lese Datei...");
            const reader = new FileReader();
            reader.onload = function(e) {
                log("Sende Datei via Relay...");
                const payload = {
                    name: file.name,
                    size: file.size,
                    data: e.target.result // Base64
                };
                
                channel.publish("file_transfer", JSON.stringify(payload));
                alert("Gesendet!");
            };
            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>
