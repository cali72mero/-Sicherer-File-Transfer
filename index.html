<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sicherer File Transfer - V3 (Stable)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; color: #333; max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h1 { text-align: center; color: #007bff; font-size: 1.5rem; margin-top: 0; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
        button.red { background: #dc3545; }
        .status { padding: 10px; text-align: center; border-radius: 8px; font-weight: bold; margin-bottom: 15px; }
        .status.green { background: #d4edda; color: #155724; }
        .status.yellow { background: #fff3cd; color: #856404; }
        .status.red { background: #f8d7da; color: #721c24; }
        .hidden { display: none; }
        .big-pin { font-size: 40px; text-align: center; letter-spacing: 5px; font-weight: bold; background: #eee; padding: 10px; border-radius: 8px; margin: 15px 0; }
        .file-list div { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .file-list div:last-child { border-bottom: none; }
        a.download-btn { background: #28a745; color: white; padding: 5px 10px; text-decoration: none; border-radius: 4px; font-size: 0.9em; }
    </style>
</head>
<body>

<h1>ðŸ“‚ Sicherer File Transfer</h1>

<!-- Status Bar -->
<div id="statusBar" class="status red">Nicht verbunden</div>

<!-- Step 1: Login -->
<div id="loginScreen" class="card">
    <h3>1. Dein Name</h3>
    <p style="color:#666; font-size:0.9em">Gib diesem GerÃ¤t einen einfachen Namen.</p>
    <input type="text" id="myIdInput" placeholder="z.B. handy, pc, laptop">
    <button onclick="startApp()">Starten</button>
</div>

<!-- Step 2: Main Interface -->
<div id="mainScreen" class="hidden">
    <div class="card">
        <h3>ðŸ‘¤ Ich bin: <span id="myIdDisplay" style="color:#007bff">...</span></h3>
        <p style="font-size:0.8em; color:#666">Serrver-Status: <span id="peerServerStatus">Warte...</span></p>
    </div>

    <!-- Connect Box -->
    <div id="connectBox" class="card">
        <h3>ðŸ”— Mit anderem GerÃ¤t verbinden</h3>
        <input type="text" id="targetIdInput" placeholder="Name des anderen GerÃ¤ts">
        <button onclick="initiateConnection()">Verbinden</button>
    </div>

    <!-- File Upload (Visible only when connected) -->
    <div id="uploadBox" class="card hidden">
        <h3>ðŸ“¤ Datei senden</h3>
        <input type="file" id="fileInput" multiple>
        <button onclick="uploadFiles()" style="background: #28a745;">Senden</button>
        <div id="transferProgress" style="margin-top:10px; font-size:0.9em; color:#666;"></div>
    </div>

    <!-- File List -->
    <div id="filesBox" class="card hidden">
        <h3>ðŸ“¥ Empfangene Dateien</h3>
        <div id="fileList" class="file-list"></div>
    </div>
</div>

<!-- PIN Receiver Modal -->
<div id="pinReceiverModal" class="card hidden" style="border: 2px solid #007bff; background: #f8f9fa;">
    <h3 style="text-align:center">ðŸ”’ Verbindungsanfrage</h3>
    <p style="text-align:center">Jemand will sich verbinden. Gib ihm diesen Code:</p>
    <div id="displayPin" class="big-pin">----</div>
    <p style="text-align:center; font-size:0.8em">Warte auf Eingabe...</p>
</div>

<!-- PIN Sender Modal -->
<div id="pinSenderModal" class="card hidden" style="border: 2px solid #007bff; background: #f8f9fa;">
    <h3 style="text-align:center">ðŸ”’ Sicherheitscode</h3>
    <p style="text-align:center">Gib den Code ein, der auf dem anderen GerÃ¤t steht:</p>
    <input type="tel" id="enterPin" placeholder="0000" maxlength="4" style="text-align:center; font-size:24px; letter-spacing:5px;">
    <button onclick="submitPin()">BestÃ¤tigen</button>
    <button class="red" onclick="cancelPin()">Abbrechen</button>
</div>

<script>
    const PREFIX = 'sft-v3-simple-';
    let peer = null;
    let conn = null;
    let myId = '';
    let tempConn = null;
    let generatedPin = '';

    // --- 1. Startup & Peer Init ---
    function startApp() {
        const rawId = document.getElementById('myIdInput').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
        if (rawId.length < 2) { alert("Name zu kurz!"); return; }

        myId = rawId;
        const fullId = PREFIX + myId;

        document.getElementById('peerServerStatus').innerText = "Verbinde zu Server...";
        
        // Create Peer (using public PeerJS server)
        peer = new Peer(fullId, {
            debug: 1,
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        });

        peer.on('open', (id) => {
            console.log('My ID:', id);
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            document.getElementById('myIdDisplay').innerText = myId;
            document.getElementById('peerServerStatus').innerText = "âœ… Online";
            updateStatus('green', 'Online als ' + myId);
        });

        peer.on('error', (err) => {
            console.error(err);
            if (err.type === 'unavailable-id') {
                alert("Name '" + myId + "' ist schon belegt. Bitte anderen wÃ¤hlen.");
                location.reload();
            } else if (err.type === 'peer-unavailable') {
                alert("GerÃ¤t nicht gefunden. Ist es online und heiÃŸt richtig?");
                updateStatus('red', 'GerÃ¤t nicht gefunden');
                resetUI();
            } else {
                document.getElementById('peerServerStatus').innerText = "âŒ Fehler: " + err.type;
            }
        });

        // Handle Incoming Connections
        peer.on('connection', (c) => {
            // If we are already connected, reject? For now simple logic: allow new, close old.
            if (conn && conn.open) {
                c.close(); 
                return;
            }
            tempConn = c;
            handleIncomingHandshake();
        });
    }

    // --- 2. Connection Handshake (The "Problem" Area) ---
    
    // SENDER: Starts here
    function initiateConnection() {
        const targetRaw = document.getElementById('targetIdInput').value.trim().toLowerCase();
        if (!targetRaw) return;
        
        const fullTargetId = PREFIX + targetRaw;
        updateStatus('yellow', 'Suche ' + targetRaw + '...');

        // Connect
        const c = peer.connect(fullTargetId, { reliable: true });

        c.on('open', () => {
            console.log("Connection opened via Server. Waiting for Auth Request...");
            updateStatus('yellow', 'Warte auf PIN-Eingabeaufforderung...');
        });

        c.on('data', (data) => {
            console.log("Sender received data:", data);
            if (data.type === 'AUTH_REQUEST') {
                // Device B is asking for PIN
                tempConn = c;
                showPinSenderModal();
            } else if (data.type === 'AUTH_SUCCESS') {
                // Success!
                conn = tempConn;
                setupActiveConnection();
                hideModals();
                updateStatus('green', 'ðŸ”’ Verbunden mit ' + targetRaw);
            } else if (data.type === 'AUTH_FAIL') {
                alert("Falscher PIN!");
                c.close();
                resetUI();
            }
        });

        c.on('close', () => { resetUI(); });
        c.on('error', (err) => { console.error(err); alert("Verbindungsfehler"); resetUI(); });
    }

    // RECEIVER: Reacts here
    function handleIncomingHandshake() {
        console.log("Incoming connection...");
        
        // Generate PIN
        generatedPin = Math.floor(1000 + Math.random() * 9000).toString();
        
        tempConn.on('open', () => {
            console.log("Connection open. Sending AUTH_REQUEST...");
            // Ask Sender for PIN
            tempConn.send({ type: 'AUTH_REQUEST' });
            
            // Show PIN on screen
            document.getElementById('displayPin').innerText = generatedPin;
            document.getElementById('pinReceiverModal').classList.remove('hidden');
            document.getElementById('connectBox').classList.add('hidden'); // Hide connect box to focus on auth
        });

        tempConn.on('data', (data) => {
            if (data.type === 'AUTH_Submit') {
                if (data.pin === generatedPin) {
                    // Correct!
                    tempConn.send({ type: 'AUTH_SUCCESS' });
                    conn = tempConn;
                    setupActiveConnection();
                    hideModals();
                    updateStatus('green', 'ðŸ”’ Verbunden!');
                } else {
                    tempConn.send({ type: 'AUTH_FAIL' });
                    setTimeout(() => tempConn.close(), 500);
                    resetUI();
                }
            }
        });
        
        tempConn.on('close', () => resetUI());
    }

    // --- 3. PIN Logic ---
    function showPinSenderModal() {
        document.getElementById('pinSenderModal').classList.remove('hidden');
        document.getElementById('connectBox').classList.add('hidden');
        document.getElementById('enterPin').value = '';
        document.getElementById('enterPin').focus();
    }

    function submitPin() {
        const val = document.getElementById('enterPin').value;
        if (tempConn && tempConn.open) {
            tempConn.send({ type: 'AUTH_Submit', pin: val });
        }
    }

    function cancelPin() {
        if (tempConn) tempConn.close();
        resetUI();
    }

    function hideModals() {
        document.getElementById('pinReceiverModal').classList.add('hidden');
        document.getElementById('pinSenderModal').classList.add('hidden');
    }

    function resetUI() {
        hideModals();
        document.getElementById('connectBox').classList.remove('hidden');
        document.getElementById('uploadBox').classList.add('hidden');
        document.getElementById('statusBar').className = 'status red';
        document.getElementById('statusBar').innerText = 'Nicht verbunden';
        conn = null;
        tempConn = null;
    }

    // --- 4. Active File Transfer ---
    function setupActiveConnection() {
        document.getElementById('uploadBox').classList.remove('hidden');
        document.getElementById('connectBox').classList.add('hidden');
        document.getElementById('filesBox').classList.remove('hidden');

        conn.on('data', (data) => {
            if (data.fileName && data.fileBlob) {
                // File received!
                const blob = new Blob([data.fileBlob], { type: data.fileType });
                const url = URL.createObjectURL(blob);
                addFileToList(data.fileName, data.fileSize, url);
            }
        });
    }

    function uploadFiles() {
        const files = document.getElementById('fileInput').files;
        if (files.length === 0) return;
        
        const feedback = document.getElementById('transferProgress');
        feedback.innerText = "Sende " + files.length + " Dateien...";

        Array.from(files).forEach(file => {
            conn.send({
                fileName: file.name,
                fileType: file.type,
                fileSize: file.size,
                fileBlob: file
            });
            feedback.innerText = "Gesendet: " + file.name;
        });
        
        setTimeout(() => feedback.innerText = "Alle Dateien gesendet!", 2000);
    }

    function addFileToList(name, size, url) {
        const list = document.getElementById('fileList');
        const div = document.createElement('div');
        const sizeStr = (size / 1024 / 1024).toFixed(2) + ' MB';
        
        div.innerHTML = `
            <div>
                <strong>${name}</strong> <small>(${sizeStr})</small>
            </div>
            <a href="${url}" download="${name}" class="download-btn">Download</a>
        `;
        list.prepend(div);
    }

    function updateStatus(cls, text) {
        const el = document.getElementById('statusBar');
        el.className = 'status ' + cls;
        el.innerText = text;
    }
</script>

</body>
</html>
