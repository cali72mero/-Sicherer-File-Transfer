<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer V13 (Live-Security)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #eef2f5; padding: 20px; color: #333; max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin: 0 0 15px 0; color: #2d3748; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; box-sizing: border-box; text-align: center; }
        button { width: 100%; padding: 14px; background: #4299e1; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 5px; }
        button.green { background: #48bb78; }
        button.red { background: #f56565; }
        button.purple { background: #805ad5; }
        .hidden { display: none; }
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; background: #cbd5e0; color: #4a5568; margin-bottom: 20px; }
        .status-badge.online { background: #c6f6d5; color: #22543d; }
        .pin-display { font-size: 48px; letter-spacing: 10px; font-weight: 800; text-align: center; background: #edf2f7; padding: 20px; border-radius: 10px; margin: 20px 0; color: #2d3748; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; vertical-align: middle; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        input:checked + .slider { background-color: #805ad5; }
        input:checked + .slider:before { transform: translateX(24px); background: white; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }

        .file-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; margin-top: 5px; border-radius: 8px; border-left: 5px solid #cbd5e0; }
        .file-encrypted { border-left-color: #805ad5; background: #faf5ff; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 90%; width: 400px; }
        .big-pass { font-size: 32px; background: #eee; padding: 15px; margin: 15px 0; font-family: monospace; letter-spacing: 2px; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

    <div style="text-align:center;">
        <h2>üîê Live-Transfer V13</h2>
        <div id="statusBadge" class="status-badge">Nicht verbunden</div>
    </div>

    <!-- 1. SETUP -->
    <div id="screenSetup" class="card">
        <h2>1. Wer bist du?</h2>
        <input type="text" id="myName" placeholder="Dein Name (z.B. handy)" onkeyup="cleanInput(this)">
        <button onclick="startApp()">Online gehen</button>
    </div>

    <!-- 2. CONNECT -->
    <div id="screenConnect" class="card hidden">
        <p style="text-align:center;">Ich bin: <strong id="dispName" style="color:#4299e1;">...</strong></p>
        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
        <h3>Verbinden</h3>
        <input type="text" id="partnerName" placeholder="Name des Partners" onkeyup="cleanInput(this)">
        <button class="green" onclick="connect()" id="btnConn">Verbinden</button>
    </div>

    <!-- 3. AUTH -->
    <div id="screenAuth" class="card hidden">
        <h2 style="text-align:center;">üîí PIN Check</h2>
        <div id="authReceiver" class="hidden">
            <p style="text-align:center;">Zeige dem Partner diesen Code:</p>
            <div id="pinDisplay" class="pin-display">----</div>
        </div>
        <div id="authSender" class="hidden">
            <p style="text-align:center;">Code eingeben:</p>
            <input type="tel" id="inputPin" placeholder="0000" maxlength="4" style="font-size:32px; letter-spacing:5px;">
            <button class="green" onclick="submitPin()">Pr√ºfen</button>
        </div>
        <button class="red" onclick="location.reload()" style="margin-top:20px;">Abbrechen</button>
    </div>

    <!-- 4. TRANSFER & TOOLS -->
    <div id="screenTransfer" class="card hidden">
        <h2 style="text-align:center; color:#48bb78;">‚úÖ Verbunden</h2>
        
        <div style="background:#f7fafc; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #e2e8f0;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span>üîí <b>Live-Verschl√ºsselung</b></span>
                <label class="switch"><input type="checkbox" id="optEncrypt" checked><span class="slider"></span></label>
            </div>
            <p style="font-size:0.8em; color:#666; margin-top:5px;">
                Wenn aktiv: Empf√§nger muss Passwort bei DIR anfragen. 
                Wenn du offline bist, kann die Datei <b>nie wieder</b> ge√∂ffnet werden.
            </p>
        </div>

        <div style="text-align:center; padding:20px; border:2px dashed #48bb78; background:#f0fff4; border-radius:10px; cursor:pointer;" onclick="document.getElementById('files').click()">
            <strong>üìÇ Dateien w√§hlen</strong>
        </div>
        <input type="file" id="files" multiple style="display:none;" onchange="processAndSend()">

        <div id="fileList" style="margin-top:20px;"></div>
    </div>

    <!-- MODAL FOR PASSWORD REQUEST (SENDER) -->
    <div id="modalReq" class="modal hidden">
        <div class="modal-box">
            <h3>üîë Anfrage!</h3>
            <p>Der Partner will <b id="reqFileName">Datei</b> √∂ffnen.</p>
            <p>Das Passwort ist:</p>
            <div id="reqPassDisplay" class="big-pass">...</div>
            <p style="font-size:0.8em">Sag es ihm oder klicke OK.</p>
            <button class="green" onclick="approveRequest()">OK (Schlie√üen)</button>
        </div>
    </div>

    <!-- MODAL FOR PASSWORD INPUT (RECEIVER) -->
    <div id="modalInput" class="modal hidden">
        <div class="modal-box">
            <h3>üîí Passwort n√∂tig</h3>
            <p>Anfrage an Sender l√§uft...</p>
            <div id="reqStatus" style="color:#d69e2e; font-weight:bold; margin:10px 0;">Warte auf Sender...</div>
            <input type="text" id="decryptPass" placeholder="Passwort eingeben" class="hidden">
            <button id="btnDecrypt" class="green hidden" onclick="confirmDecrypt()">Entschl√ºsseln</button>
            <button class="red" onclick="closeModal()" style="margin-top:10px">Abbrechen</button>
        </div>
    </div>

    <script>
        const PREFIX = 'sft-v13-live-';
        const ICE_SERVERS = [{ urls: 'stun:stun.l.google.com:19302' }];
        let peer, conn, myPin, myName;
        
        // Memory for live keys
        let activeKeys = {}; // fileName -> password
        let pendingDecryptName = '';
        let pendingRawData = null;

        function cleanInput(el) { el.value = el.value.toLowerCase().replace(/[^a-z0-9]/g, ''); }
        function setStatus(msg, type) { document.getElementById('statusBadge').className = 'status-badge '+type; document.getElementById('statusBadge').innerText = msg; }
        
        // --- 1. START ---
        function startApp() {
            myName = document.getElementById('myName').value;
            if (myName.length < 2) return alert("Name zu kurz");
            
            peer = new Peer(PREFIX + myName, { debug: 1, config: { iceServers: ICE_SERVERS } });
            
            peer.on('open', () => {
                setStatus('Online: ' + myName, 'online');
                document.getElementById('screenSetup').classList.add('hidden');
                document.getElementById('screenConnect').classList.remove('hidden');
                document.getElementById('dispName').innerText = myName;
            });
            
            peer.on('error', (e) => { alert(e.type); location.reload(); });
            
            peer.on('connection', (c) => {
                conn = c;
                c.on('open', () => {
                    myPin = Math.floor(1000 + Math.random()*9000).toString();
                    document.getElementById('screenConnect').classList.add('hidden');
                    document.getElementById('screenAuth').classList.remove('hidden');
                    document.getElementById('authReceiver').classList.remove('hidden');
                    document.getElementById('pinDisplay').innerText = myPin;
                    c.send({ type: 'AUTH_REQ' });
                });
                setupData();
            });
        }

        function connect() {
            const p = document.getElementById('partnerName').value;
            conn = peer.connect(PREFIX + p);
            conn.on('open', setupData);
        }

        // --- PROTOCOL ---
        function setupData() {
            conn.on('data', (d) => {
                // Auth
                if (d.type === 'AUTH_REQ') {
                    document.getElementById('screenConnect').classList.add('hidden');
                    document.getElementById('screenAuth').classList.remove('hidden');
                    document.getElementById('authSender').classList.remove('hidden');
                }
                if (d.type === 'PIN_CHECK') {
                    if (d.pin === myPin) { conn.send({type:'AUTH_OK'}); showTrans(); }
                    else { conn.send({type:'AUTH_FAIL'}); alert('Falsch'); location.reload(); }
                }
                if (d.type === 'AUTH_OK') showTrans();

                // Files
                if (d.type === 'FILE') receiveFile(d);

                // Live Key Request (SENDER SIDE)
                if (d.type === 'KEY_REQ') {
                    const pass = activeKeys[d.fileName];
                    if (pass) {
                        document.getElementById('modalReq').classList.remove('hidden');
                        document.getElementById('reqFileName').innerText = d.fileName;
                        document.getElementById('reqPassDisplay').innerText = pass;
                        // We do NOT send the pass automatically. We wait for user (as requested).
                        // Or we can auto send if user approves. 
                        // The user said: "Sender displays password".
                    } else {
                        // Key lost?
                        conn.send({ type: 'KEY_DENY', reason: 'Unbekannte Datei oder abgelaufen' });
                    }
                }
            });

            conn.on('close', () => {
                setStatus('Partner offline', 'offline');
                // If receiver is waiting for key, fail
                if (!document.getElementById('modalInput').classList.contains('hidden')) {
                     document.getElementById('reqStatus').innerText = "‚ùå Sender ist offline! Entschl√ºsselung unm√∂glich.";
                     document.getElementById('reqStatus').style.color = 'red';
                }
            });
        }

        function submitPin() { conn.send({ type: 'PIN_CHECK', pin: document.getElementById('inputPin').value }); }
        function showTrans() { 
            document.getElementById('screenAuth').classList.add('hidden');
            document.getElementById('screenTransfer').classList.remove('hidden');
            setStatus('Verbunden', 'online');
        }

        // --- 5. SENDING ---
        async function processAndSend() {
            const files = document.getElementById('files').files;
            const encrypt = document.getElementById('optEncrypt').checked;

            for (let f of files) {
                let buffer = await f.arrayBuffer();
                let isEncrypted = false;

                if (encrypt) {
                    // Generate One-Time Password
                    const pass = Math.random().toString(36).slice(-8).toUpperCase();
                    activeKeys[f.name] = pass; // Store in memory
                    
                    const key = await getKey(pass);
                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    const encryptedContent = await crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, buffer);
                    
                    const combined = new Uint8Array(iv.length + encryptedContent.byteLength);
                    combined.set(iv);
                    combined.set(new Uint8Array(encryptedContent), iv.length);
                    buffer = combined.buffer;
                    isEncrypted = true;
                }

                conn.send({
                    type: 'FILE',
                    name: f.name,
                    mime: isEncrypted ? 'application/octet-stream' : f.type,
                    data: buffer,
                    encrypted: isEncrypted
                });
            }
            alert("Gesendet!");
        }

        async function getKey(password) {
            const enc = new TextEncoder();
            const k = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
            return crypto.subtle.deriveKey({ name: "PBKDF2", salt: enc.encode("salt"), iterations: 100000, hash: "SHA-256" }, k, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]);
        }

        // --- 6. RECEIVING & REQUESTING KEY ---
        function receiveFile(d) {
            const div = document.createElement('div');
            div.className = d.encrypted ? 'file-item file-encrypted' : 'file-item';
            
            let btnHtml = '';
            if (d.encrypted) {
                btnHtml = `<button class="purple" onclick="requestUnlock('${d.name}')">üîì Anfrage senden</button>`;
                // Store raw data
                if(!window.tempFiles) window.tempFiles = {};
                window.tempFiles[d.name] = d.data;
            } else {
                const blob = new Blob([d.data], {type: d.mime});
                const url = URL.createObjectURL(blob);
                btnHtml = `<a href="${url}" download="${d.name}" style="background:#48bb78; color:white; padding:8px 15px; text-decoration:none; border-radius:5px;">üíæ Laden</a>`;
            }

            div.innerHTML = `<div><strong>${d.name}</strong> ${d.encrypted?'üîí':''}<br><small>${(d.data.byteLength/1024).toFixed(1)} KB</small></div>${btnHtml}`;
            document.getElementById('fileList').prepend(div);
        }

        // --- LIVE KEY RETRIEVAL FLOW ---
        function requestUnlock(name) {
            if (!conn || !conn.open) return alert("Fehler: Sender ist offline. Datei kann nicht entschl√ºsselt werden!");
            
            pendingDecryptName = name;
            
            // Show UI
            document.getElementById('modalInput').classList.remove('hidden');
            document.getElementById('reqStatus').innerText = "‚è≥ Anfrage an Sender gesendet...";
            document.getElementById('reqStatus').style.color = '#d69e2e';
            
            // Send Request
            conn.send({ type: 'KEY_REQ', fileName: name });
        }

        // Sender approves (Just closes modal, Sender tells password manually via voice/chat as requested)
        function approveRequest() {
            document.getElementById('modalReq').classList.add('hidden');
        }

        // Receiver manually enters the password they got from Sender
        // (Wait... if Sender is offline, they can't get it. This matches requirement.)
        async function confirmDecrypt() {
            const pass = document.getElementById('decryptPass').value;
            if(!pass) return alert("Passwort eingeben!");
            
            try {
                const raw = window.tempFiles[pendingDecryptName];
                const iv = raw.slice(0, 12);
                const data = raw.slice(12);
                const key = await getKey(pass);
                const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, data);
                
                const blob = new Blob([decrypted]);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = pendingDecryptName;
                a.click();
                
                closeModal();
            } catch (e) {
                alert("Falsches Passwort!");
            }
        }
        
        // In this logic, the Sender verbally tells the password. 
        // We need to enable the input field for receiver once request is 'acknowledged' or just always let them type?
        // Let's make the input field visible immediately so they can type what Sender tells them.
        // Wait, better: The Sender sees the password. The Receiver sees "Enter Password".
        
        // MODIFYING requestUnlock to show input immediately
        // Redefine requestUnlock
        window.requestUnlock = function(name) {
            if (!conn || !conn.open) return alert("Sender ist offline! Datei verloren.");
            
            pendingDecryptName = name;
            conn.send({ type: 'KEY_REQ', fileName: name });
            
            document.getElementById('modalInput').classList.remove('hidden');
            document.getElementById('reqStatus').innerText = "Frage Sender nach Passwort...";
            // Enable input
            document.getElementById('decryptPass').classList.remove('hidden');
            document.getElementById('btnDecrypt').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalInput').classList.add('hidden');
            document.getElementById('decryptPass').value = '';
        }

    </script>
</body>
</html>
