<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple File Transfer V4</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; padding: 20px; background: #fafafa; color: #333; max-width: 600px; margin: 0 auto; text-align: center; }
        .box { background: white; border: 1px solid #ddd; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h1, h2 { margin-top: 0; }
        input { font-size: 18px; padding: 10px; width: 80%; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; text-align: center; }
        button { font-size: 18px; padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px; }
        button.green { background: #28a745; }
        button.red { background: #dc3545; }
        .hidden { display: none; }
        #debugLog { font-family: monospace; font-size: 12px; color: #666; text-align: left; background: #eee; padding: 10px; margin-top: 20px; height: 100px; overflow-y: scroll; }
        .pin-display { font-size: 48px; letter-spacing: 5px; font-weight: bold; background: #e9ecef; padding: 20px; margin: 10px 0; border-radius: 10px; }
    </style>
</head>
<body>

    <h1>âš¡ Einfacher Transfer V4</h1>

    <!-- Phase 1: Setup -->
    <div id="setup" class="box">
        <h2>Wer bist du?</h2>
        <input type="text" id="myName" placeholder="Dein Name (z.B. handy)" onkeyup="this.value = this.value.toLowerCase().replace(/[^a-z0-9]/g, '')">
        <button onclick="initMyPeer()">Starten</button>
    </div>

    <!-- Phase 2: Main Menu -->
    <div id="menu" class="box hidden">
        <h2>Hallo, <span id="displayName" style="color:#007bff"></span></h2>
        <p>Status: <span id="status">Warte auf Server...</span></p>
        
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

        <h3>Verbinden mit:</h3>
        <input type="text" id="targetName" placeholder="Name des Partners">
        <button class="green" onclick="connectToPartner()">Verbinden</button>
    </div>

    <!-- Phase 3: Auth (PIN) -->
    <div id="authReceiver" class="box hidden">
        <h3>ðŸ”’ PIN Code</h3>
        <p>Der andere muss diesen Code eingeben:</p>
        <div id="myPin" class="pin-display">----</div>
        <button class="red" onclick="location.reload()">Abbrechen</button>
    </div>

    <div id="authSender" class="box hidden">
        <h3>ðŸ”’ Code eingeben</h3>
        <p>Gib den Code vom anderen GerÃ¤t ein:</p>
        <input type="tel" id="inputPin" placeholder="0000" style="font-size: 30px; letter-spacing: 5px;">
        <button class="green" onclick="submitPin()">BestÃ¤tigen</button>
        <button class="red" onclick="location.reload()">Abbrechen</button>
    </div>

    <!-- Phase 4: File Transfer -->
    <div id="transfer" class="box hidden">
        <h2 style="color:#28a745">âœ… Verbunden!</h2>
        
        <div style="border: 2px dashed #ccc; padding: 20px; margin: 20px 0;">
            <p>Datei auswÃ¤hlen:</p>
            <input type="file" id="fileInput" multiple>
            <button onclick="uploadFiles()">Senden</button>
        </div>

        <div id="fileList" style="text-align:left;"></div>
    </div>

    <div id="debugLog">Log startet...</div>

    <script>
        // --- Core Variables ---
        const APP_PREFIX = 'sft-v4-simple-';
        let peer, conn, myId;
        let activeConn = null;
        let generatedPin = '';

        function log(msg) {
            const d = document.getElementById('debugLog');
            d.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
        }

        // --- 1. Init ---
        function initMyPeer() {
            const name = document.getElementById('myName').value;
            if (name.length < 2) { alert('Name zu kurz'); return; }
            
            myId = name;
            const fullId = APP_PREFIX + name;
            
            log('Starte Peer: ' + fullId);
            
            peer = new Peer(fullId);

            peer.on('open', (id) => {
                log('Verbunden mit Server als: ' + id);
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('menu').classList.remove('hidden');
                document.getElementById('displayName').innerText = myId;
                document.getElementById('status').innerText = 'Online (Bereit)';
                document.getElementById('status').style.color = 'green';
            });

            peer.on('error', (err) => {
                log('FEHLER: ' + err.type);
                alert('Fehler: ' + err.type);
                if (err.type === 'unavailable-id') location.reload();
            });

            // Incoming Connection Handler (Receiver)
            peer.on('connection', (c) => {
                log('Eingehende Verbindung von: ' + c.peer);
                activeConn = c;
                
                // 1. Wait for connection to be open
                c.on('open', () => {
                    log('Verbindung offen! Starte Auth...');
                    startReceiverAuth();
                });

                // 2. Fallback: Sometimes 'open' doesn't fire if already open
                if (c.open) startReceiverAuth();
            });
        }

        // --- 2. Sender Logic ---
        function connectToPartner() {
            const target = document.getElementById('targetName').value;
            if (!target) return;
            
            const fullTarget = APP_PREFIX + target;
            log('Verbinde zu: ' + fullTarget);
            
            // Connect
            const c = peer.connect(fullTarget);
            
            c.on('open', () => {
                log('Verbindung zum Partner hergestellt!');
                activeConn = c;
                document.getElementById('menu').classList.add('hidden');
                document.getElementById('authSender').classList.remove('hidden');
                setupDataListener(c);
            });
            
            c.on('error', (err) => log('Verbindungsfehler: ' + err));
            
            // Force open check after 2s
            setTimeout(() => {
                if (!c.open) log('Verbindung dauert lange...');
            }, 2000);
        }

        // --- 3. Auth Logic ---
        
        // Receiver Side
        function startReceiverAuth() {
            generatedPin = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('authReceiver').classList.remove('hidden');
            document.getElementById('myPin').innerText = generatedPin;
            
            log('Warte auf PIN: ' + generatedPin);
            
            setupDataListener(activeConn);
        }

        // Sender Side
        function submitPin() {
            const pin = document.getElementById('inputPin').value;
            log('Sende PIN: ' + pin);
            activeConn.send({ type: 'PIN_ATTEMPT', pin: pin });
        }

        // --- 4. Data Listener (Both Sides) ---
        function setupDataListener(c) {
            c.on('data', (data) => {
                log('Daten empfangen: ' + data.type);
                
                // Auth Handshake
                if (data.type === 'PIN_ATTEMPT') {
                    if (data.pin === generatedPin) {
                        log('PIN korrekt!');
                        c.send({ type: 'PIN_OK' });
                        showTransferScreen();
                    } else {
                        log('PIN falsch!');
                        c.send({ type: 'PIN_FAIL' });
                        alert('Falscher Code!');
                        location.reload();
                    }
                }
                
                if (data.type === 'PIN_OK') {
                    log('Partner hat PIN akzeptiert!');
                    showTransferScreen();
                }

                if (data.type === 'PIN_FAIL') {
                    alert('Falscher Code!');
                    location.reload();
                }

                // File Transfer
                if (data.fileName && data.fileBlob) {
                    log('Datei empfangen: ' + data.fileName);
                    const blob = new Blob([data.fileBlob]);
                    const url = URL.createObjectURL(blob);
                    
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <div style="background:#e9ecef; padding:10px; margin:5px 0; border-radius:5px;">
                            <strong>${data.fileName}</strong><br>
                            <a href="${url}" download="${data.fileName}" style="color:blue">Download</a>
                        </div>`;
                    document.getElementById('fileList').prepend(div);
                }
            });

            c.on('close', () => {
                log('Verbindung geschlossen');
                alert('Partner hat die Verbindung getrennt');
                location.reload();
            });
        }

        function showTransferScreen() {
            document.getElementById('authReceiver').classList.add('hidden');
            document.getElementById('authSender').classList.add('hidden');
            document.getElementById('transfer').classList.remove('hidden');
        }

        // --- 5. Upload ---
        function uploadFiles() {
            const files = document.getElementById('fileInput').files;
            Array.from(files).forEach(f => {
                log('Sende Datei: ' + f.name);
                activeConn.send({
                    fileName: f.name,
                    fileBlob: f,
                    type: 'FILE'
                });
            });
            alert('Gesendet!');
        }

    </script>
</body>
</html>
