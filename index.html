<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sicherer File Transfer - Pro</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
      --success: #10b981;
      --danger: #ef4444;
      --bg: #f3f4f6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    
    body {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      min-height: 100vh;
      padding: 15px;
      color: #333;
    }

    .container { max-width: 800px; margin: 0 auto; }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    h1 { color: var(--primary); text-align: center; margin-bottom: 5px; font-size: 1.5rem; }
    .subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9em; }

    /* Custom ID Section */
    .id-setup {
      background: #f8fafc;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      text-align: center;
    }

    /* Recent Peers List */
    .recent-list {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .recent-chip {
      background: #e0e7ff;
      color: #4338ca;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      cursor: pointer;
      border: 1px solid #c7d2fe;
    }
    .recent-chip:hover { background: #c7d2fe; }

    /* Status Bar */
    .status-bar {
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }
    .status-offline { background: #fee2e2; color: #991b1b; }
    .status-connecting { background: #fef3c7; color: #92400e; }
    .status-online { background: #d1fae5; color: #065f46; }

    /* Inputs & Buttons */
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px; /* Prevents zoom on iOS */
      margin-bottom: 10px;
    }
    input:focus { outline: none; border-color: var(--primary); }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      touch-action: manipulation;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    
    /* Upload Area */
    .upload-area {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      background: #f8fafc;
      cursor: pointer;
    }
    
    /* File List */
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 4px solid var(--primary);
    }
    .file-meta { display: flex; flex-direction: column; overflow: hidden; }
    .file-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
    .file-size { font-size: 0.8em; color: #666; }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(2px);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      padding: 20px;
    }
    .modal {
      background: white; padding: 25px; border-radius: 16px;
      width: 100%; max-width: 350px; text-align: center;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .pin-display {
      font-size: 36px; letter-spacing: 5px; font-weight: bold;
      color: var(--primary); margin: 20px 0;
      background: #f3f4f6; padding: 15px; border-radius: 8px;
      font-family: monospace;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="container">
  <div class="card">
    <h1>üöÄ Sicherer File Transfer</h1>
    <p class="subtitle">P2P ‚Ä¢ Verschl√ºsselt ‚Ä¢ V2.1</p>
    
    <!-- ID Setup -->
    <div id="setupPanel" class="id-setup">
      <h3>üëã Dein Name</h3>
      <p style="color: #666; margin: 10px 0;">Wie soll dieses Ger√§t hei√üen?</p>
      <input type="text" id="myCustomId" placeholder="z.B. Mein-Handy" maxlength="20" onkeypress="handleEnter(event, initPeer)">
      <button class="btn btn-primary" onclick="initPeer()">Starten</button>
    </div>

    <!-- Main App -->
    <div id="appPanel" class="hidden">
      <div id="statusBox" class="status-bar status-offline">Offline</div>
      
      <!-- Connection Panel -->
      <div class="card" style="border: 1px solid #e5e7eb;">
        <h3>üîó Verbindung herstellen</h3>
        <p style="font-size: 0.9em; color: #666; margin: 10px 0;">Name des anderen Ger√§ts:</p>
        
        <input type="text" id="targetIdInput" placeholder="z.B. Dein-PC" onkeypress="handleEnter(event, connectToPeer)">
        <button class="btn btn-primary" onclick="connectToPeer()">Verbinden</button>
        
        <!-- Recent Devices -->
        <div id="recentPeers" class="recent-list hidden">
          <!-- Filled by JS -->
        </div>

        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; font-size: 0.9em;">
          Dein Name: <strong id="displayId" style="color: var(--primary);">...</strong>
        </div>
      </div>

      <!-- Upload Panel -->
      <div class="card">
        <h3>üìÇ Dateien</h3>
        <div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
          <div style="font-size: 30px; margin-bottom: 5px;">üì§</div>
          <div>Hier klicken zum Ausw√§hlen</div>
        </div>
        <input type="file" id="fileInput" multiple hidden>
        
        <div id="fileListContainer" style="margin-top: 20px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- PIN Receiver Modal -->
<div id="authModalReceiver" class="modal-overlay hidden">
  <div class="modal">
    <h3>üîí PIN Code</h3>
    <p>Verbindung von <span id="incomingName" style="font-weight:bold">...</span></p>
    <div id="pinDisplay" class="pin-display">----</div>
    <p style="font-size: 0.85em; color: #666;">Zeige diesen Code dem Sender.</p>
    <button class="btn btn-danger" onclick="rejectConnection()" style="margin-top: 15px;">Ablehnen</button>
  </div>
</div>

<!-- PIN Sender Modal -->
<div id="authModalSender" class="modal-overlay hidden">
  <div class="modal">
    <h3>üîí PIN Eingabe</h3>
    <p style="margin-bottom:15px">Gib den Code vom Empf√§nger ein:</p>
    
    <input type="tel" id="pinInput" placeholder="0000" maxlength="4" 
           style="text-align: center; font-size: 24px; letter-spacing: 5px; font-weight: bold;"
           onkeypress="handleEnter(event, submitPin)">
           
    <button class="btn btn-success" onclick="submitPin()" style="margin-bottom: 10px;">Verbinden</button>
    <button class="btn" onclick="cancelAuth()" style="background: transparent; color: #666; border: 1px solid #ddd;">Abbrechen</button>
  </div>
</div>

<script>
  // --- Config & State ---
  const PREFIX = 'sft-pro-v2-';
  let peer, conn, myName;
  let pendingConn = null;
  let currentPin = '';
  let receivedFiles = []; 
  let recentDevices = JSON.parse(localStorage.getItem('sft_recents') || '[]');

  // --- Helpers ---
  function handleEnter(e, func) {
    if (e.key === 'Enter') func();
  }
  
  function updateStatus(cls, msg) {
    const el = document.getElementById('statusBox');
    el.className = 'status-bar status-' + cls;
    el.textContent = msg;
  }

  // --- Main Logic ---
  function initPeer() {
    myName = document.getElementById('myCustomId').value.trim().replace(/[^a-zA-Z0-9-]/g, '');
    if (myName.length < 2) {
      alert('Name zu kurz (min 2 Zeichen)');
      return;
    }

    const fullId = PREFIX + myName;
    peer = new Peer(fullId);

    peer.on('open', (id) => {
      document.getElementById('setupPanel').classList.add('hidden');
      document.getElementById('appPanel').classList.remove('hidden');
      document.getElementById('displayId').textContent = myName;
      updateStatus('online', '‚úÖ Bereit als: ' + myName);
      loadRecents();
    });

    peer.on('connection', (c) => {
      pendingConn = c;
      // Fix: Check if already open or wait for open
      if (pendingConn.open) {
        startReceiverAuth();
      } else {
        pendingConn.on('open', () => startReceiverAuth());
      }
    });

    peer.on('error', (err) => {
      if (err.type === 'unavailable-id') {
        alert('Dieser Name ist schon belegt. W√§hle einen anderen.');
        location.reload();
      } else {
        updateStatus('offline', '‚ùå Fehler: ' + err.type);
      }
    });
  }

  // --- Receiver Auth ---
  function startReceiverAuth() {
    // Generate simple 4 digit PIN
    currentPin = Math.floor(1000 + Math.random() * 9000).toString();
    
    // Extract sender name from peer ID if possible
    let senderName = pendingConn.peer.replace(PREFIX, '');
    document.getElementById('incomingName').textContent = senderName;
    document.getElementById('pinDisplay').textContent = currentPin;
    document.getElementById('authModalReceiver').classList.remove('hidden');

    // Listen for PIN
    pendingConn.on('data', (data) => {
      if (data.type === 'auth-pin') {
        if (data.pin === currentPin) {
          // Success
          document.getElementById('authModalReceiver').classList.add('hidden');
          conn = pendingConn;
          setupActiveConnection();
          conn.send({ type: 'auth-success' });
          updateStatus('online', 'üîí Verbunden mit ' + senderName);
        } else {
          // Fail
          pendingConn.send({ type: 'auth-fail' });
          setTimeout(() => pendingConn.close(), 500);
          document.getElementById('authModalReceiver').classList.add('hidden');
          alert('Falscher PIN eingegeben!');
        }
      }
    });
  }

  // --- Sender Auth ---
  function connectToPeer(targetNameOverride) {
    let targetName = targetNameOverride || document.getElementById('targetIdInput').value.trim();
    if (typeof targetName !== 'string') targetName = document.getElementById('targetIdInput').value.trim(); // handle event arg
    
    if (!targetName) return;

    updateStatus('connecting', '‚è≥ Suche ' + targetName + '...');
    const fullTargetId = PREFIX + targetName;
    
    const c = peer.connect(fullTargetId);
    
    c.on('open', () => {
      pendingConn = c;
      document.getElementById('authModalSender').classList.remove('hidden');
      
      // Better Input Handling for Mobile
      setTimeout(() => {
        const input = document.getElementById('pinInput');
        input.value = '';
        input.focus();
      }, 100);
    });

    c.on('data', (data) => {
      if (data.type === 'auth-success') {
        document.getElementById('authModalSender').classList.add('hidden');
        conn = pendingConn;
        setupActiveConnection();
        updateStatus('online', 'üîí Verbunden mit ' + targetName);
        addToRecents(targetName);
      } else if (data.type === 'auth-fail') {
        alert('Falscher PIN! Verbindung abgelehnt.');
        document.getElementById('authModalSender').classList.add('hidden');
        updateStatus('offline', '‚ùå Authentifizierung fehlgeschlagen');
      }
    });

    c.on('error', (err) => {
      updateStatus('offline', '‚ùå ' + targetName + ' nicht gefunden');
    });
    
    // Timeout fallback if connection hangs
    setTimeout(() => {
      if (!conn && !document.getElementById('authModalSender').classList.contains('hidden') && !pendingConn.open) {
         updateStatus('offline', '‚ùå Zeit√ºberschreitung');
      }
    }, 10000);
  }

  function submitPin() {
    const pin = document.getElementById('pinInput').value;
    if (!pin || pin.length < 4) return;
    
    if (pendingConn && pendingConn.open) {
      pendingConn.send({ type: 'auth-pin', pin: pin });
      // UI Feedback
      const btn = document.querySelector('#authModalSender .btn-success');
      const originalText = btn.textContent;
      btn.textContent = 'Pr√ºfe...';
      setTimeout(() => btn.textContent = originalText, 2000);
    } else {
      alert('Verbindung verloren. Bitte neu versuchen.');
      cancelAuth();
    }
  }

  function cancelAuth() {
    if (pendingConn) pendingConn.close();
    document.getElementById('authModalSender').classList.add('hidden');
    updateStatus('online', 'Bereit');
  }

  function rejectConnection() {
    if (pendingConn) pendingConn.close();
    document.getElementById('authModalReceiver').classList.add('hidden');
  }

  // --- Active Session ---
  function setupActiveConnection() {
    conn.on('data', (data) => {
      if (data.fileName && data.fileBlob) {
        handleReceivedFile(data);
      }
    });

    conn.on('close', () => {
      updateStatus('offline', '‚ö†Ô∏è Partner getrennt');
      conn = null;
    });
  }

  function handleReceivedFile(fileData) {
    let finalName = fileData.fileName;
    let counter = 1;
    
    // Intelligent renaming: name.jpg -> name (1).jpg
    while (receivedFiles.some(f => f.name === finalName)) {
      const lastDot = fileData.fileName.lastIndexOf('.');
      if (lastDot !== -1) {
        const name = fileData.fileName.substring(0, lastDot);
        const ext = fileData.fileName.substring(lastDot);
        finalName = `${name} (${counter})${ext}`;
      } else {
        finalName = `${fileData.fileName} (${counter})`;
      }
      counter++;
    }

    const blob = new Blob([fileData.fileBlob], { type: fileData.fileType });
    const url = URL.createObjectURL(blob);
    const fileObj = { name: finalName, size: fileData.fileSize, url: url };
    
    receivedFiles.push(fileObj);
    addFileToUI(fileObj, true);
  }

  // --- Upload ---
  const fileInput = document.getElementById('fileInput');
  const dropZone = document.getElementById('dropZone');

  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('dragover'); });
  dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); processFiles(e.dataTransfer.files); });
  fileInput.addEventListener('change', (e) => processFiles(e.target.files));

  function processFiles(files) {
    if (!conn) {
      alert('Keine Verbindung! Erst verbinden.');
      return;
    }

    Array.from(files).forEach(file => {
      conn.send({
        fileName: file.name,
        fileType: file.type,
        fileSize: file.size,
        fileBlob: file
      });
      addFileToUI({ name: file.name, size: file.size }, false);
    });
  }

  function addFileToUI(file, isIncoming) {
    const list = document.getElementById('fileListContainer');
    const div = document.createElement('div');
    div.className = 'file-item';
    
    const action = isIncoming 
      ? `<a href="${file.url}" download="${file.name}" class="btn btn-success" style="width:auto; padding:8px 15px; font-size:0.9em">üíæ Laden</a>`
      : `<span style="color:var(--success); font-weight:bold;">‚úì</span>`;

    div.innerHTML = `
      <div class="file-meta">
        <span class="file-name">${isIncoming ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è'} ${file.name}</span>
        <span class="file-size">${formatBytes(file.size)}</span>
      </div>
      <div>${action}</div>
    `;
    list.insertBefore(div, list.firstChild);
  }

  // --- Utils ---
  function loadRecents() {
    const container = document.getElementById('recentPeers');
    if (recentDevices.length > 0) {
      container.classList.remove('hidden');
      container.innerHTML = recentDevices.map(name => 
        `<span class="recent-chip" onclick="connectToPeer('${name}')">üì± ${name}</span>`
      ).join('');
    }
  }

  function addToRecents(name) {
    if (!recentDevices.includes(name)) {
      recentDevices.unshift(name);
      if (recentDevices.length > 5) recentDevices.pop();
      localStorage.setItem('sft_recents', JSON.stringify(recentDevices));
      loadRecents();
    }
  }

  function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }
</script>

</body>
</html>
