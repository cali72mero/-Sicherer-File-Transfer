<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sicherer Transfer V11 (Secure PIN)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #eef2f5; padding: 20px; color: #333; max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin: 0 0 15px 0; color: #2d3748; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; box-sizing: border-box; text-align: center; }
        button { width: 100%; padding: 14px; background: #4299e1; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
        button.green { background: #48bb78; }
        button.red { background: #f56565; }
        .hidden { display: none; }
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; background: #cbd5e0; color: #4a5568; margin-bottom: 20px; }
        .status-badge.online { background: #c6f6d5; color: #22543d; }
        .pin-display { font-size: 48px; letter-spacing: 10px; font-weight: 800; text-align: center; background: #edf2f7; padding: 20px; border-radius: 10px; margin: 20px 0; color: #2d3748; }
        .file-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f7fafc; margin-top: 5px; border-radius: 5px; }
    </style>
</head>
<body>

    <div style="text-align:center;">
        <h2>üõ°Ô∏è Transfer V11</h2>
        <div id="statusBadge" class="status-badge">Nicht verbunden</div>
    </div>

    <!-- 1. SETUP -->
    <div id="screenSetup" class="card">
        <h2>1. Wer bist du?</h2>
        <p style="color:#718096; margin-bottom:10px;">Gib deinem Ger√§t einen Namen:</p>
        <input type="text" id="myName" placeholder="z.B. handy" onkeyup="cleanInput(this)">
        <button onclick="startApp()">Online gehen</button>
    </div>

    <!-- 2. CONNECT -->
    <div id="screenConnect" class="card hidden">
        <p style="text-align:center; color:#718096;">Dein Name: <strong id="dispName" style="color:#4299e1; font-size:1.2em;">...</strong></p>
        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
        
        <h3>Verbinden mit...</h3>
        <input type="text" id="partnerName" placeholder="Name des anderen Ger√§ts" onkeyup="cleanInput(this)">
        <button class="green" onclick="connect()" id="btnConn">Verbinden</button>
    </div>

    <!-- 3. AUTH (PIN) -->
    <div id="screenAuth" class="card hidden">
        <h2 style="text-align:center;">üîí Sicherheits-Check</h2>
        
        <!-- Empf√§nger sieht das -->
        <div id="authReceiver" class="hidden">
            <p style="text-align:center;">Verbindung von <strong id="incomingName">...</strong></p>
            <p style="text-align:center;">Zeige ihm diesen Code:</p>
            <div id="pinDisplay" class="pin-display">----</div>
        </div>

        <!-- Sender sieht das -->
        <div id="authSender" class="hidden">
            <p style="text-align:center;">Verbunden! Gib den Code ein:</p>
            <input type="tel" id="inputPin" placeholder="0000" maxlength="4" style="font-size:32px; letter-spacing:5px;">
            <button class="green" onclick="submitPin()">Pr√ºfen</button>
        </div>
        
        <button class="red" onclick="location.reload()" style="margin-top:20px; background:transparent; color:#f56565; border:1px solid #f56565;">Abbrechen</button>
    </div>

    <!-- 4. TRANSFER -->
    <div id="screenTransfer" class="card hidden">
        <h2 style="text-align:center; color:#48bb78;">‚úÖ Sicher Verbunden</h2>
        
        <div style="text-align:center; padding:30px; border:2px dashed #48bb78; background:#f0fff4; border-radius:10px; cursor:pointer;" onclick="document.getElementById('files').click()">
            <span style="font-size:40px;">üìÇ</span><br>
            <strong>Dateien ausw√§hlen</strong>
        </div>
        <input type="file" id="files" multiple style="display:none;" onchange="sendFiles()">

        <div id="fileList" style="margin-top:20px;"></div>
    </div>

    <script>
        // --- CONFIG ---
        const PREFIX = 'sft-v11-secure-'; // Unique prefix to map names to IDs
        const ICE_SERVERS = [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:global.stun.twilio.com:3478' }
        ];

        let peer, conn, myPin;
        let myName = '';
        let authenticated = false;

        function cleanInput(el) { el.value = el.value.toLowerCase().replace(/[^a-z0-9]/g, ''); }
        function setStatus(msg, type) {
            const el = document.getElementById('statusBadge');
            el.innerText = msg;
            el.className = 'status-badge ' + type;
        }

        // --- 1. START ---
        function startApp() {
            const name = document.getElementById('myName').value;
            if (name.length < 2) return alert("Name zu kurz");
            myName = name;

            setStatus('Verbinde...', '');
            
            peer = new Peer(PREFIX + name, {
                debug: 1,
                config: { iceServers: ICE_SERVERS }
            });

            peer.on('open', (id) => {
                setStatus('Online: ' + name, 'online');
                document.getElementById('screenSetup').classList.add('hidden');
                document.getElementById('screenConnect').classList.remove('hidden');
                document.getElementById('dispName').innerText = name;
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') alert("Name schon vergeben!");
                else alert("Fehler: " + err.type);
                setStatus('Fehler', 'offline');
            });

            // RECEIVER LOGIC
            peer.on('connection', (c) => {
                // If already connected, reject new ones? For now, allow overwrite or handle simple
                conn = c;
                setStatus('Authentifiziere...', '');
                
                c.on('open', () => {
                    // Generate PIN
                    myPin = Math.floor(1000 + Math.random() * 9000).toString();
                    
                    // Show PIN UI
                    document.getElementById('screenConnect').classList.add('hidden');
                    document.getElementById('screenAuth').classList.remove('hidden');
                    document.getElementById('authReceiver').classList.remove('hidden');
                    document.getElementById('pinDisplay').innerText = myPin;
                    document.getElementById('incomingName').innerText = c.peer.replace(PREFIX, '');

                    // Request Auth
                    c.send({ type: 'AUTH_REQUIRED' });
                });

                setupDataHandler();
            });
        }

        // --- 2. CONNECT (SENDER) ---
        function connect() {
            const partner = document.getElementById('partnerName').value;
            if (!partner) return;

            document.getElementById('btnConn').innerText = 'Verbinde...';
            
            conn = peer.connect(PREFIX + partner);

            conn.on('open', () => {
                setStatus('Warte auf PIN...', '');
                setupDataHandler();
            });

            conn.on('error', (err) => {
                alert("Verbindung fehlgeschlagen");
                location.reload();
            });

            // Safety timeout
            setTimeout(() => {
                if(!authenticated && !document.getElementById('screenAuth').classList.contains('hidden')) {
                    // Just waiting...
                } else if (!conn.open) {
                    alert("Keine Antwort vom Partner.");
                    location.reload();
                }
            }, 8000);
        }

        // --- 3. DATA HANDLER ---
        function setupDataHandler() {
            conn.on('data', (data) => {
                // AUTH FLOW
                if (data.type === 'AUTH_REQUIRED') {
                    // Sender needs to enter PIN
                    document.getElementById('screenConnect').classList.add('hidden');
                    document.getElementById('screenAuth').classList.remove('hidden');
                    document.getElementById('authSender').classList.remove('hidden');
                }

                if (data.type === 'PIN_CHECK') {
                    // Receiver checks PIN
                    if (data.pin === myPin) {
                        conn.send({ type: 'AUTH_SUCCESS' });
                        authenticated = true;
                        showTransfer();
                    } else {
                        conn.send({ type: 'AUTH_FAIL' });
                        setTimeout(() => conn.close(), 500); // Kick
                        alert("Falscher PIN! Verbindung getrennt.");
                        location.reload();
                    }
                }

                if (data.type === 'AUTH_SUCCESS') {
                    authenticated = true;
                    showTransfer();
                }

                if (data.type === 'AUTH_FAIL') {
                    alert("Falscher PIN! Verbindung abgelehnt.");
                    location.reload();
                }

                // FILE TRANSFER
                if (data.type === 'FILE') {
                    receiveFile(data);
                }
            });

            conn.on('close', () => {
                if(authenticated) alert("Partner hat die Verbindung getrennt.");
                location.reload();
            });
        }

        function submitPin() {
            const pin = document.getElementById('inputPin').value;
            conn.send({ type: 'PIN_CHECK', pin: pin });
        }

        function showTransfer() {
            document.getElementById('screenAuth').classList.add('hidden');
            document.getElementById('screenTransfer').classList.remove('hidden');
            setStatus('Verbunden mit ' + conn.peer.replace(PREFIX, ''), 'online');
        }

        // --- 4. FILES ---
        function sendFiles() {
            const files = document.getElementById('files').files;
            Array.from(files).forEach(f => {
                conn.send({
                    type: 'FILE',
                    name: f.name,
                    file: f,
                    size: f.size,
                    mime: f.type
                });
            });
            alert(files.length + " Datei(en) gesendet!");
        }

        function receiveFile(data) {
            const blob = new Blob([data.file], { type: data.mime });
            const url = URL.createObjectURL(blob);
            
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
                <div>
                    <strong>${data.name}</strong> <small>(${(data.size/1024/1024).toFixed(2)} MB)</small>
                </div>
                <a href="${url}" download="${data.name}" style="background:#48bb78; color:white; padding:8px 15px; text-decoration:none; border-radius:5px;">Download</a>
            `;
            document.getElementById('fileList').prepend(div);
        }
    </script>
</body>
</html>
